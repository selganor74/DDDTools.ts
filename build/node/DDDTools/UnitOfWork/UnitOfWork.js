"use strict";
var InProcessDispatcher_1 = require("../DomainEvents/InProcessDispatcher");
var IdentityMap_1 = require("./IdentityMap");
var ObjectDeletedEvent_1 = require("./ObjectDeletedEvent");
var ObjectRetrievedEvent_1 = require("./ObjectRetrievedEvent");
var ObjectSavedEvent_1 = require("./ObjectSavedEvent");
var UnitOfWorkErrors_1 = require("./UnitOfWorkErrors");
var UnitOfWork = (function () {
    function UnitOfWork(repository) {
        this.repository = repository;
        this.idMap = new IdentityMap_1.IdentityMap();
        this.dispatcher = new InProcessDispatcher_1.InProcessDispatcher();
    }
    UnitOfWork.prototype.getById = function (key) {
        if (this.idMap.isTracked(key)) {
            if (this.idMap.getItemStatus(key) === IdentityMap_1.ItemStatus.Deleted) {
                UnitOfWorkErrors_1.UnitOfWorkErrors.throw(UnitOfWorkErrors_1.UnitOfWorkErrors.ItemMarkedAsDeleted);
            }
            return this.idMap.getById(key);
        }
        var toReturn = this.repository.getById(key);
        this.idMap.add(key, toReturn);
        this.idMap.markAsSavedById(key);
        var retrievedEvent = new ObjectRetrievedEvent_1.ObjectRetrievedEvent(toReturn.__typeName, toReturn.__typeVersion, toReturn.getKey().toString());
        this.raiseEvent(retrievedEvent);
        return toReturn;
    };
    UnitOfWork.prototype.deleteById = function (key) {
        this.idMap.markAsDeletedById(key);
    };
    UnitOfWork.prototype.saveAll = function () {
        var keys = this.idMap.getIds();
        for (var _i = 0, keys_1 = keys; _i < keys_1.length; _i++) {
            var key = keys_1[_i];
            this.idMap.updateSavedItemStatus(key);
            var status = this.idMap.getItemStatus(key);
            switch (status) {
                case IdentityMap_1.ItemStatus.Deleted:
                    this.processDeletedItem(key);
                    break;
                case IdentityMap_1.ItemStatus.Modified:
                case IdentityMap_1.ItemStatus.New:
                    this.processNewOrModifiedItem(key);
                    break;
                case IdentityMap_1.ItemStatus.Saved:
                    break;
            }
        }
    };
    UnitOfWork.prototype.registerHandler = function (eventTypeName, eventHandler) {
        this.dispatcher.registerHandler(eventTypeName, eventHandler);
    };
    UnitOfWork.prototype.unregisterHandler = function (eventTypeName, eventHandler) {
        this.dispatcher.unregisterHandler(eventTypeName, eventHandler);
    };
    UnitOfWork.prototype.processDeletedItem = function (key) {
        var item = this.idMap.getById(key);
        var deletedEvent = new ObjectDeletedEvent_1.ObjectDeletedEvent(item.__typeName, item.__typeVersion, key.toString());
        this.repository.delete(key);
        this.removeById(key);
        this.raiseEvent(deletedEvent);
    };
    UnitOfWork.prototype.processNewOrModifiedItem = function (key) {
        var item = this.idMap.getById(key);
        this.repository.save(item);
        this.idMap.markAsSavedById(key);
        var savedEvent = new ObjectSavedEvent_1.ObjectSavedEvent(item.__typeName, item.__typeVersion, key.toString());
        this.raiseEvent(savedEvent);
    };
    UnitOfWork.prototype.raiseEvent = function (event) {
        this.dispatcher.dispatch(event);
    };
    UnitOfWork.prototype.removeById = function (key) {
        if (this.idMap.isTracked(key)) {
            this.idMap.remove(key);
        }
    };
    return UnitOfWork;
}());
exports.UnitOfWork = UnitOfWork;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVW5pdE9mV29yay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9ERERUb29scy9Vbml0T2ZXb3JrL1VuaXRPZldvcmsudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQU1BLG9DQUFrQyxxQ0FBcUMsQ0FBQyxDQUFBO0FBR3hFLDRCQUFzQyxlQUFlLENBQUMsQ0FBQTtBQUN0RCxtQ0FBaUMsc0JBQXNCLENBQUMsQ0FBQTtBQUN4RCxxQ0FBbUMsd0JBQXdCLENBQUMsQ0FBQTtBQUM1RCxpQ0FBK0Isb0JBQW9CLENBQUMsQ0FBQTtBQUNwRCxpQ0FBK0Isb0JBQW9CLENBQUMsQ0FBQTtBQUtwRDtJQU1JLG9CQUFZLFVBQWdDO1FBQ3hDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSx5QkFBVyxFQUFXLENBQUM7UUFDeEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLHlDQUFtQixFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUtNLDRCQUFPLEdBQWQsVUFBZSxHQUFTO1FBRXBCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyx3QkFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZELG1DQUFnQixDQUFDLEtBQUssQ0FBQyxtQ0FBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ2pFLENBQUM7WUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkMsQ0FBQztRQUVELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FB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VUFBVSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDM0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU8sK0JBQVUsR0FBbEIsVUFBbUIsS0FBbUI7UUFDbEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUtPLCtCQUFVLEdBQWxCLFVBQW1CLEdBQVM7UUFDeEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNCLENBQUM7SUFDTCxDQUFDO0lBQ0wsaUJBQUM7QUFBRCxDQUFDLEFBdEdELElBc0dDO0FBdEdZLGtCQUFVLGFBc0d0QixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbmFtZXNwYWNlIERERFRvb2xzLlVuaXRPZldvcmsge1xyXG5cclxuaW1wb3J0IHtCYXNlQWdncmVnYXRlUm9vdH0gZnJvbSBcIi4uL0FnZ3JlZ2F0ZS9CYXNlQWdncmVnYXRlUm9vdFwiO1xyXG5pbXBvcnQge0lLZXlWYWx1ZU9iamVjdH0gZnJvbSBcIi4uL0VudGl0eS9JS2V5VmFsdWVPYmplY3RcIjtcclxuaW1wb3J0IHtJUmVwb3NpdG9yeX0gZnJvbSBcIi4uL1JlcG9zaXRvcnkvSVJlcG9zaXRvcnlcIjtcclxuaW1wb3J0IHtTZXJpYWxpemVyfSBmcm9tIFwiLi4vU2VyaWFsaXphdGlvbi9TZXJpYWxpemVyXCI7XHJcbmltcG9ydCB7SW5Qcm9jZXNzRGlzcGF0Y2hlcn0gZnJvbSBcIi4uL0RvbWFpbkV2ZW50cy9JblByb2Nlc3NEaXNwYXRjaGVyXCI7XHJcbmltcG9ydCB7SURvbWFpbkV2ZW50fSBmcm9tIFwiLi4vRG9tYWluRXZlbnRzL0lEb21haW5FdmVudFwiO1xyXG5pbXBvcnQge0lFdmVudEhhbmRsZXJ9IGZyb20gXCIuLi9Eb21haW5FdmVudHMvSUV2ZW50SGFuZGxlclwiO1xyXG5pbXBvcnQge0lkZW50aXR5TWFwLCBJdGVtU3RhdHVzfSBmcm9tIFwiLi9JZGVudGl0eU1hcFwiO1xyXG5pbXBvcnQge09iamVjdERlbGV0ZWRFdmVudH0gZnJvbSBcIi4vT2JqZWN0RGVsZXRlZEV2ZW50XCI7XHJcbmltcG9ydCB7T2JqZWN0UmV0cmlldmVkRXZlbnR9IGZyb20gXCIuL09iamVjdFJldHJpZXZlZEV2ZW50XCI7XHJcbmltcG9ydCB7T2JqZWN0U2F2ZWRFdmVudH0gZnJvbSBcIi4vT2JqZWN0U2F2ZWRFdmVudFwiO1xyXG5pbXBvcnQge1VuaXRPZldvcmtFcnJvcnN9IGZyb20gXCIuL1VuaXRPZldvcmtFcnJvcnNcIjtcclxuXHJcbi8qKlxyXG4gKiBTaW1wbGUgVW5pdE9mV29yayBmb3IgYSBzaW5nbGUgUmVwb3NpdG9yeS5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBVbml0T2ZXb3JrPFQgZXh0ZW5kcyBCYXNlQWdncmVnYXRlUm9vdDxULCBUS2V5PiwgVEtleSBleHRlbmRzIElLZXlWYWx1ZU9iamVjdDxUS2V5Pj4ge1xyXG5cclxuICAgIHByaXZhdGUgaWRNYXA6IElkZW50aXR5TWFwPFQsIFRLZXk+O1xyXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBJUmVwb3NpdG9yeTxULCBUS2V5PjtcclxuICAgIHByaXZhdGUgZGlzcGF0Y2hlcjogSW5Qcm9jZXNzRGlzcGF0Y2hlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihyZXBvc2l0b3J5OiBJUmVwb3NpdG9yeTxULCBUS2V5Pikge1xyXG4gICAgICAgIHRoaXMucmVwb3NpdG9yeSA9IHJlcG9zaXRvcnk7XHJcbiAgICAgICAgdGhpcy5pZE1hcCA9IG5ldyBJZGVudGl0eU1hcDxULCBUS2V5PigpO1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hlciA9IG5ldyBJblByb2Nlc3NEaXNwYXRjaGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXRyaWV2ZXMgYW4gaXRlbSBmcm9tIHRoZSBSZXBvc2l0b3J5IG9yIGZyb20gdGhlIFVuaXRPZldvcmssIGdpdmVuIGl0cyBJZC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGdldEJ5SWQoa2V5OiBUS2V5KTogVCB7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlkTWFwLmlzVHJhY2tlZChrZXkpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlkTWFwLmdldEl0ZW1TdGF0dXMoa2V5KSA9PT0gSXRlbVN0YXR1cy5EZWxldGVkKSB7XHJcbiAgICAgICAgICAgICAgICBVbml0T2ZXb3JrRXJyb3JzLnRocm93KFVuaXRPZldvcmtFcnJvcnMuSXRlbU1hcmtlZEFzRGVsZXRlZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWRNYXAuZ2V0QnlJZChrZXkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdmFyIHRvUmV0dXJuID0gdGhpcy5yZXBvc2l0b3J5LmdldEJ5SWQoa2V5KTtcclxuICAgICAgICB0aGlzLmlkTWFwLmFkZChrZXksIHRvUmV0dXJuKTtcclxuICAgICAgICB0aGlzLmlkTWFwLm1hcmtBc1NhdmVkQnlJZChrZXkpO1xyXG5cclxuICAgICAgICB2YXIgcmV0cmlldmVkRXZlbnQgPSBuZXcgT2JqZWN0UmV0cmlldmVkRXZlbnQodG9SZXR1cm4uX190eXBlTmFtZSwgdG9SZXR1cm4uX190eXBlVmVyc2lvbiwgdG9SZXR1cm4uZ2V0S2V5KCkudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgdGhpcy5yYWlzZUV2ZW50KHJldHJpZXZlZEV2ZW50KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHRvUmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTWFya3MgYW4gaXRlbSBhcyBkZWxldGVkIGZyb20gdGhlIFVuaXRPZldvcmsgKGFuZCBmcm9tIHRoZSBSZXBvc2l0b3J5IHdoZW4gdGhlIFVvVyB3aWxsIGJlIHNhdmVkKVxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgZGVsZXRlQnlJZChrZXk6IFRLZXkpIHtcclxuICAgICAgICB0aGlzLmlkTWFwLm1hcmtBc0RlbGV0ZWRCeUlkKGtleSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTYXZlcyBhbGwgdGhlIG1vZGlmaWVkIGl0ZW1zIGluIHRoZSBVbml0T2ZXb3JrLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc2F2ZUFsbCgpIHtcclxuICAgICAgICB2YXIga2V5cyA9IHRoaXMuaWRNYXAuZ2V0SWRzKCk7XHJcbiAgICAgICAgZm9yICh2YXIga2V5IG9mIGtleXMpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaWRNYXAudXBkYXRlU2F2ZWRJdGVtU3RhdHVzKGtleSk7XHJcbiAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0aGlzLmlkTWFwLmdldEl0ZW1TdGF0dXMoa2V5KTtcclxuXHJcbiAgICAgICAgICAgIHN3aXRjaCAoc3RhdHVzKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEl0ZW1TdGF0dXMuRGVsZXRlZDpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NEZWxldGVkSXRlbShrZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBJdGVtU3RhdHVzLk1vZGlmaWVkOlxyXG4gICAgICAgICAgICAgICAgY2FzZSBJdGVtU3RhdHVzLk5ldzpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NOZXdPck1vZGlmaWVkSXRlbShrZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBJdGVtU3RhdHVzLlNhdmVkOlxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZWdpc3RlckhhbmRsZXIoZXZlbnRUeXBlTmFtZTogc3RyaW5nLCBldmVudEhhbmRsZXI6IElFdmVudEhhbmRsZXIpIHtcclxuICAgICAgICB0aGlzLmRpc3BhdGNoZXIucmVnaXN0ZXJIYW5kbGVyKGV2ZW50VHlwZU5hbWUsIGV2ZW50SGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVucmVnaXN0ZXJIYW5kbGVyKGV2ZW50VHlwZU5hbWU6IHN0cmluZywgZXZlbnRIYW5kbGVyOiBJRXZlbnRIYW5kbGVyKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwYXRjaGVyLnVucmVnaXN0ZXJIYW5kbGVyKGV2ZW50VHlwZU5hbWUsIGV2ZW50SGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwcm9jZXNzRGVsZXRlZEl0ZW0oa2V5OiBUS2V5KSB7XHJcbiAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmlkTWFwLmdldEJ5SWQoa2V5KTtcclxuICAgICAgICB2YXIgZGVsZXRlZEV2ZW50ID0gbmV3IE9iamVjdERlbGV0ZWRFdmVudChpdGVtLl9fdHlwZU5hbWUsIGl0ZW0uX190eXBlVmVyc2lvbiwga2V5LnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIHRoaXMucmVwb3NpdG9yeS5kZWxldGUoa2V5KTtcclxuICAgICAgICB0aGlzLnJlbW92ZUJ5SWQoa2V5KTtcclxuICAgICAgICB0aGlzLnJhaXNlRXZlbnQoZGVsZXRlZEV2ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NOZXdPck1vZGlmaWVkSXRlbShrZXk6IFRLZXkpIHtcclxuICAgICAgICB2YXIgaXRlbSA9IHRoaXMuaWRNYXAuZ2V0QnlJZChrZXkpO1xyXG4gICAgICAgIHRoaXMucmVwb3NpdG9yeS5zYXZlKGl0ZW0pO1xyXG4gICAgICAgIHRoaXMuaWRNYXAubWFya0FzU2F2ZWRCeUlkKGtleSk7XHJcbiAgICAgICAgLy8gcmFpc2VzIGFuIGV2ZW50IGZvciB3aG9tZXZlciBpcyBpbnRlcmVzdGVkXHJcbiAgICAgICAgdmFyIHNhdmVkRXZlbnQgPSBuZXcgT2JqZWN0U2F2ZWRFdmVudChpdGVtLl9fdHlwZU5hbWUsIGl0ZW0uX190eXBlVmVyc2lvbiwga2V5LnRvU3RyaW5nKCkpO1xyXG4gICAgICAgIHRoaXMucmFpc2VFdmVudChzYXZlZEV2ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJhaXNlRXZlbnQoZXZlbnQ6IElEb21haW5FdmVudCkge1xyXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hlci5kaXNwYXRjaChldmVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb21wbGV0ZWx5IHJlbW92ZXMgYW4gb2JqZWN0IGZyb20gdGhlIElkZW50aXR5TWFwXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcmVtb3ZlQnlJZChrZXk6IFRLZXkpIHtcclxuICAgICAgICBpZiAodGhpcy5pZE1hcC5pc1RyYWNrZWQoa2V5KSkge1xyXG4gICAgICAgICAgICB0aGlzLmlkTWFwLnJlbW92ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4vLyB9XHJcbiJdfQ==