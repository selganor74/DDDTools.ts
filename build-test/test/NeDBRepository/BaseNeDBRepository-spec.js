var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
define(["require", "exports", "../../DDDTools/ValueObjects/Guid", "../../DDDTools/Aggregate/BaseAggregateRoot", "../../NeDBRepository/BaseNeDBRepositoryAsync", "../../DDDTools/PersistableObject/Factory", "../../NeDBRepository/NeDBDatabaseFactory"], function (require, exports, Guid_1, BaseAggregateRoot_1, BaseNeDBRepositoryAsync_1, Factory_1, NeDBDatabaseFactory_1) {
    "use strict";
    var TestKey = (function (_super) {
        __extends(TestKey, _super);
        function TestKey() {
            _super.call(this);
            this.__typeName = "TestKey";
            this.__typeVersion = "v1";
        }
        return TestKey;
    }(Guid_1.Guid));
    exports.TestKey = TestKey;
    var TestAggregate = (function (_super) {
        __extends(TestAggregate, _super);
        function TestAggregate() {
            _super.call(this);
            this.__typeName = "TestAggregate";
            this.__typeVersion = "v1";
        }
        return TestAggregate;
    }(BaseAggregateRoot_1.BaseAggregateRoot));
    exports.TestAggregate = TestAggregate;
    var TestRepo = (function (_super) {
        __extends(TestRepo, _super);
        function TestRepo() {
            _super.apply(this, arguments);
        }
        return TestRepo;
    }(BaseNeDBRepositoryAsync_1.BaseNeDBRepositoryAsync));
    describe("BaseNeDBRepository", function () {
        var key;
        var persistenceTestAggregate;
        Factory_1.Factory.registerType("TestKey", "v1", TestKey);
        Factory_1.Factory.registerType("TestAggregate", "v1", TestAggregate);
        var inMemoryDb = NeDBDatabaseFactory_1.NeDBDatabaseFactory.getAndRegisterInMemoryDb("TestAggregateInMemory");
        var persistentDb = NeDBDatabaseFactory_1.NeDBDatabaseFactory.getAndRegisterPersistentDb("TestAggregatePersistent");
        it("Should be possible to instantiate the NeDB Object.", function () {
            var nedbRepo = new TestRepo("TestAggregate", inMemoryDb);
            expect(true).toBeTruthy();
        });
        it("Should be possible to insert and retrieve an item", function (done) {
            var testItem = new TestAggregate();
            var testKey = new TestKey();
            var testRepo = new TestRepo("TestAggregate", inMemoryDb);
            testItem.setKey(testKey);
            testRepo.save(testItem).then(function () {
                testRepo.getById(testKey).then(function (retrieved) {
                    expect(retrieved).toEqual(testItem);
                    expect(retrieved.equals(testItem)).toBeTruthy();
                    expect(retrieved.perfectlyMatch(testItem)).toBeTruthy();
                    done();
                }, function (error) {
                    expect(false).toBeTruthy("There was an error while retrieving the item.");
                    done();
                });
            }, function (error) {
                expect(false).toBeTruthy("There was an error while retrieving the item.");
                done();
            });
        });
        it("RevisionId must be incremented only if object to be saved differs from object saved", function (done) {
            var repo = new TestRepo("TestAggregate", inMemoryDb);
            var e = new TestAggregate();
            e.setKey(new TestKey());
            e.aTestProperty = "Before saving...";
            expect(e.getRevisionId()).toEqual(0);
            repo.save(e).then(function () {
                expect(e.getRevisionId()).toEqual(1);
                repo.save(e).then(function () {
                    expect(e.getRevisionId()).toEqual(1);
                    e.aTestProperty = "... after saving";
                    repo.save(e).then(function () {
                        expect(e.getRevisionId()).toEqual(2);
                        done();
                    });
                });
            });
        });
        it("A repository built with filename option MUST be persistent - part 1 saving", function (done) {
            var repo1 = new TestRepo("TestAggregate", persistentDb);
            persistenceTestAggregate = new TestAggregate();
            persistenceTestAggregate.aTestProperty = "Wow this has been saved.";
            key = new TestKey();
            persistenceTestAggregate.setKey(key);
            repo1.save(persistenceTestAggregate).then(function () {
                expect(true).toBeTruthy();
                done();
            }, function (err) {
                expect(false).toBeTruthy("First Save failed");
                done();
            });
        });
        it("A repository built with filename option MUST be persistent - part 2 retrieving", function (done) {
            var repo2 = new TestRepo("TestAggregate", persistentDb);
            repo2.getById(key).then(function (doc) {
                expect(doc.perfectlyMatch(persistenceTestAggregate)).toBeTruthy();
                done();
            }, function (err) {
                expect(false).toBeTruthy(JSON.stringify(err));
                done();
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzZU5lREJSZXBvc2l0b3J5LXNwZWMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdGVzdC9OZURCUmVwb3NpdG9yeS9CYXNlTmVEQlJlcG9zaXRvcnktc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0lBV0E7UUFBNkIsMkJBQUk7UUFDN0I7WUFDSSxpQkFBTyxDQUFDO1lBQ1IsSUFBSSxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7WUFDNUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7UUFDOUIsQ0FBQztRQUNMLGNBQUM7SUFBRCxDQUFDLEFBTkQsQ0FBNkIsV0FBSSxHQU1oQztJQU5ZLGVBQU8sVUFNbkIsQ0FBQTtJQUVEO1FBQW1DLGlDQUF5QztRQUl4RTtZQUNJLGlCQUFPLENBQUM7WUFDUixJQUFJLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQztZQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQztRQUM5QixDQUFDO1FBQ0wsb0JBQUM7SUFBRCxDQUFDLEFBVEQsQ0FBbUMscUNBQWlCLEdBU25EO0lBVFkscUJBQWEsZ0JBU3pCLENBQUE7SUFFRDtRQUF1Qiw0QkFBK0M7UUFBdEU7WUFBdUIsOEJBQStDO1FBRXRFLENBQUM7UUFBRCxlQUFDO0lBQUQsQ0FBQyxBQUZELENBQXVCLGlEQUF1QixHQUU3QztJQUVELFFBQVEsQ0FBQyxvQkFBb0IsRUFBRTtRQUUzQixJQUFJLEdBQVksQ0FBQztRQUNqQixJQUFJLHdCQUF1QyxDQUFDO1FBRTVDLGlCQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDL0MsaUJBQU8sQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztRQUUzRCxJQUFJLFVBQVUsR0FBRyx5Q0FBbUIsQ0FBQyx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3ZGLElB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QyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxFQUFFLENBQUM7WUFDWCxDQUFDLENBQ0osQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vLi4vdHlwaW5ncy9icm93c2VyLmQudHNcIi8+XHJcblxyXG5pbXBvcnQge0d1aWR9IGZyb20gXCIuLi8uLi9ERERUb29scy9WYWx1ZU9iamVjdHMvR3VpZFwiO1xyXG5pbXBvcnQge0lBZ2dyZWdhdGVSb290fSBmcm9tIFwiLi4vLi4vREREVG9vbHMvQWdncmVnYXRlL0lBZ2dyZWdhdGVSb290XCI7XHJcbmltcG9ydCB7QmFzZUFnZ3JlZ2F0ZVJvb3R9IGZyb20gXCIuLi8uLi9ERERUb29scy9BZ2dyZWdhdGUvQmFzZUFnZ3JlZ2F0ZVJvb3RcIjtcclxuaW1wb3J0IHtCYXNlTmVEQlJlcG9zaXRvcnlBc3luY30gZnJvbSBcIi4uLy4uL05lREJSZXBvc2l0b3J5L0Jhc2VOZURCUmVwb3NpdG9yeUFzeW5jXCI7XHJcbmltcG9ydCB7QmFzZUtleVZhbHVlT2JqZWN0fSBmcm9tIFwiLi4vLi4vREREVG9vbHMvRW50aXR5L0Jhc2VLZXlWYWx1ZU9iamVjdFwiO1xyXG5pbXBvcnQge0ZhY3Rvcnl9IGZyb20gXCIuLi8uLi9ERERUb29scy9QZXJzaXN0YWJsZU9iamVjdC9GYWN0b3J5XCI7XHJcbmltcG9ydCB7SUVudGl0eX0gZnJvbSBcIi4uLy4uL0RERFRvb2xzL0VudGl0eS9JRW50aXR5XCI7XHJcbmltcG9ydCB7TmVEQkRhdGFiYXNlRmFjdG9yeX0gZnJvbSBcIi4uLy4uL05lREJSZXBvc2l0b3J5L05lREJEYXRhYmFzZUZhY3RvcnlcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBUZXN0S2V5IGV4dGVuZHMgR3VpZCB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuX190eXBlTmFtZSA9IFwiVGVzdEtleVwiO1xyXG4gICAgICAgIHRoaXMuX190eXBlVmVyc2lvbiA9IFwidjFcIjtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFRlc3RBZ2dyZWdhdGUgZXh0ZW5kcyBCYXNlQWdncmVnYXRlUm9vdDxUZXN0QWdncmVnYXRlLCBUZXN0S2V5PiB7XHJcblxyXG4gICAgcHVibGljIGFUZXN0UHJvcGVydHk6IHN0cmluZztcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMuX190eXBlTmFtZSA9IFwiVGVzdEFnZ3JlZ2F0ZVwiO1xyXG4gICAgICAgIHRoaXMuX190eXBlVmVyc2lvbiA9IFwidjFcIjtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgVGVzdFJlcG8gZXh0ZW5kcyBCYXNlTmVEQlJlcG9zaXRvcnlBc3luYzxUZXN0QWdncmVnYXRlLCBUZXN0S2V5PiB7XHJcblxyXG59XHJcblxyXG5kZXNjcmliZShcIkJhc2VOZURCUmVwb3NpdG9yeVwiLCAoKSA9PiB7XHJcbiAgICBcclxuICAgIHZhciBrZXk6IFRlc3RLZXk7IC8vIG5lZWRlZCBieSBwZXJzaXN0ZW5jZSB0ZXN0c1xyXG4gICAgdmFyIHBlcnNpc3RlbmNlVGVzdEFnZ3JlZ2F0ZTogVGVzdEFnZ3JlZ2F0ZTtcclxuICAgIFxyXG4gICAgRmFjdG9yeS5yZWdpc3RlclR5cGUoXCJUZXN0S2V5XCIsIFwidjFcIiwgVGVzdEtleSk7XHJcbiAgICBGYWN0b3J5LnJlZ2lzdGVyVHlwZShcIlRlc3RBZ2dyZWdhdGVcIiwgXCJ2MVwiLCBUZXN0QWdncmVnYXRlKTtcclxuXHJcbiAgICB2YXIgaW5NZW1vcnlEYiA9IE5lREJEYXRhYmFzZUZhY3RvcnkuZ2V0QW5kUmVnaXN0ZXJJbk1lbW9yeURiKFwiVGVzdEFnZ3JlZ2F0ZUluTWVtb3J5XCIpO1xyXG4gICAgdmFyIHBlcnNpc3RlbnREYiA9IE5lREJEYXRhYmFzZUZhY3RvcnkuZ2V0QW5kUmVnaXN0ZXJQZXJzaXN0ZW50RGIoXCJUZXN0QWdncmVnYXRlUGVyc2lzdGVudFwiKTtcclxuICAgIFxyXG4gICAgaXQoXCJTaG91bGQgYmUgcG9zc2libGUgdG8gaW5zdGFudGlhdGUgdGhlIE5lREIgT2JqZWN0LlwiLCAoKSA9PiB7XHJcbiAgICAgICAgdmFyIG5lZGJSZXBvID0gbmV3IFRlc3RSZXBvKFwiVGVzdEFnZ3JlZ2F0ZVwiLCBpbk1lbW9yeURiKTtcclxuICAgICAgICBleHBlY3QodHJ1ZSkudG9CZVRydXRoeSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoXCJTaG91bGQgYmUgcG9zc2libGUgdG8gaW5zZXJ0IGFuZCByZXRyaWV2ZSBhbiBpdGVtXCIsIChkb25lKSA9PiB7XHJcblxyXG4gICAgICAgIHZhciB0ZXN0SXRlbSA9IG5ldyBUZXN0QWdncmVnYXRlKCk7XHJcbiAgICAgICAgdmFyIHRlc3RLZXkgPSBuZXcgVGVzdEtleSgpO1xyXG4gICAgICAgIHZhciB0ZXN0UmVwbyA9IG5ldyBUZXN0UmVwbyhcIlRlc3RBZ2dyZWdhdGVcIiwgaW5NZW1vcnlEYik7XHJcblxyXG4gICAgICAgIHRlc3RJdGVtLnNldEtleSh0ZXN0S2V5KTtcclxuXHJcbiAgICAgICAgdGVzdFJlcG8uc2F2ZSh0ZXN0SXRlbSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRlc3RSZXBvLmdldEJ5SWQodGVzdEtleSkudGhlbihcclxuICAgICAgICAgICAgICAgIChyZXRyaWV2ZWQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBleHBlY3QocmV0cmlldmVkKS50b0VxdWFsKHRlc3RJdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBCZWluZyBFbnRpdGllcyB0aGUgZXF1YWxzIG1ldGhvZCBzaG91bGQgcmV0dXJuIHRydWUgaWYgd2UgYXJlIHRhbGtpbmcgYWJvdXQgdGhlIHNhbWUgZW50aXR5LlxyXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChyZXRyaWV2ZWQuZXF1YWxzKHRlc3RJdGVtKSkudG9CZVRydXRoeSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChyZXRyaWV2ZWQucGVyZmVjdGx5TWF0Y2godGVzdEl0ZW0pKS50b0JlVHJ1dGh5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9uZSgpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChmYWxzZSkudG9CZVRydXRoeShcIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSByZXRyaWV2aW5nIHRoZSBpdGVtLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZmFsc2UpLnRvQmVUcnV0aHkoXCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgcmV0cmlldmluZyB0aGUgaXRlbS5cIik7XHJcbiAgICAgICAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIGl0KFwiUmV2aXNpb25JZCBtdXN0IGJlIGluY3JlbWVudGVkIG9ubHkgaWYgb2JqZWN0IHRvIGJlIHNhdmVkIGRpZmZlcnMgZnJvbSBvYmplY3Qgc2F2ZWRcIiwgKGRvbmUpID0+IHtcclxuICAgICAgICAvLyBwZW5kaW5nKFwiTmVlZCB0byByZWZhY3RvciBJUEVyc2lzdGFibGUgdG8gYWRkIGZ1bmN0aW9ucyBmb3IgU3RhdGUgQ29tcGFyaXNvbi5cIik7XHJcblxyXG4gICAgICAgIHZhciByZXBvID0gbmV3IFRlc3RSZXBvKFwiVGVzdEFnZ3JlZ2F0ZVwiLCBpbk1lbW9yeURiKTtcclxuICAgICAgICB2YXIgZSA9IG5ldyBUZXN0QWdncmVnYXRlKCk7XHJcbiAgICAgICAgZS5zZXRLZXkobmV3IFRlc3RLZXkoKSk7XHJcbiAgICAgICAgZS5hVGVzdFByb3BlcnR5ID0gXCJCZWZvcmUgc2F2aW5nLi4uXCI7XHJcblxyXG4gICAgICAgIGV4cGVjdChlLmdldFJldmlzaW9uSWQoKSkudG9FcXVhbCgwKTtcclxuXHJcbiAgICAgICAgcmVwby5zYXZlKGUpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBleHBlY3QoZS5nZXRSZXZpc2lvbklkKCkpLnRvRXF1YWwoMSk7XHJcbiAgICAgICAgICAgIHJlcG8uc2F2ZShlKS50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGV4cGVjdChlLmdldFJldmlzaW9uSWQoKSkudG9FcXVhbCgxKTtcclxuICAgICAgICAgICAgICAgIGUuYVRlc3RQcm9wZXJ0eSA9IFwiLi4uIGFmdGVyIHNhdmluZ1wiO1xyXG4gICAgICAgICAgICAgICAgcmVwby5zYXZlKGUpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4cGVjdChlLmdldFJldmlzaW9uSWQoKSkudG9FcXVhbCgyKTtcclxuICAgICAgICAgICAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcIkEgcmVwb3NpdG9yeSBidWlsdCB3aXRoIGZpbGVuYW1lIG9wdGlvbiBNVVNUIGJlIHBlcnNpc3RlbnQgLSBwYXJ0IDEgc2F2aW5nXCIsIChkb25lKSA9PiB7XHJcbiAgICAgICAgdmFyIHJlcG8xID0gbmV3IFRlc3RSZXBvKFwiVGVzdEFnZ3JlZ2F0ZVwiLCBwZXJzaXN0ZW50RGIpO1xyXG5cclxuICAgICAgICBwZXJzaXN0ZW5jZVRlc3RBZ2dyZWdhdGUgPSBuZXcgVGVzdEFnZ3JlZ2F0ZSgpO1xyXG4gICAgICAgIHBlcnNpc3RlbmNlVGVzdEFnZ3JlZ2F0ZS5hVGVzdFByb3BlcnR5ID0gXCJXb3cgdGhpcyBoYXMgYmVlbiBzYXZlZC5cIjtcclxuICAgICAgICBrZXkgPSBuZXcgVGVzdEtleSgpO1xyXG4gICAgICAgIHBlcnNpc3RlbmNlVGVzdEFnZ3JlZ2F0ZS5zZXRLZXkoa2V5KTtcclxuICAgICAgICBcclxuICAgICAgICByZXBvMS5zYXZlKHBlcnNpc3RlbmNlVGVzdEFnZ3JlZ2F0ZSkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIGV4cGVjdCh0cnVlKS50b0JlVHJ1dGh5KCk7XHJcbiAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZmFsc2UpLnRvQmVUcnV0aHkoXCJGaXJzdCBTYXZlIGZhaWxlZFwiKTtcclxuICAgICAgICAgICAgICAgIGRvbmUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChcIkEgcmVwb3NpdG9yeSBidWlsdCB3aXRoIGZpbGVuYW1lIG9wdGlvbiBNVVNUIGJlIHBlcnNpc3RlbnQgLSBwYXJ0IDIgcmV0cmlldmluZ1wiLCAoZG9uZSkgPT4ge1xyXG4gICAgICAgIHZhciByZXBvMiA9IG5ldyBUZXN0UmVwbyhcIlRlc3RBZ2dyZWdhdGVcIiwgcGVyc2lzdGVudERiKTtcclxuXHJcbiAgICAgICAgcmVwbzIuZ2V0QnlJZChrZXkpLnRoZW4oXHJcbiAgICAgICAgICAgIChkb2MpID0+IHtcclxuICAgICAgICAgICAgICAgIGV4cGVjdChkb2MucGVyZmVjdGx5TWF0Y2gocGVyc2lzdGVuY2VUZXN0QWdncmVnYXRlKSkudG9CZVRydXRoeSgpO1xyXG4gICAgICAgICAgICAgICAgZG9uZSgpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZmFsc2UpLnRvQmVUcnV0aHkoSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgICAgICBkb25lKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApOyAgICAgICAgIFxyXG4gICAgfSk7XHJcbn0pO1xyXG4iXX0=