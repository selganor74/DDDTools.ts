define(["require", "exports"], function (require, exports) {
    "use strict";
    (function (ItemStatus) {
        ItemStatus[ItemStatus["New"] = 0] = "New";
        ItemStatus[ItemStatus["Modified"] = 1] = "Modified";
        ItemStatus[ItemStatus["Saved"] = 2] = "Saved";
        ItemStatus[ItemStatus["Deleted"] = 3] = "Deleted";
    })(exports.ItemStatus || (exports.ItemStatus = {}));
    var ItemStatus = exports.ItemStatus;
    var TrackedItem = (function () {
        function TrackedItem(status, item, key) {
            this.status = status;
            this.item = item;
            this.key = key;
            this.asLoaded = item.getState();
        }
        TrackedItem.prototype.markAsNew = function () {
            this.status = ItemStatus.New;
            this.asLoaded = this.item.getState();
        };
        TrackedItem.prototype.markAsSaved = function () {
            this.status = ItemStatus.Saved;
            this.asLoaded = this.item.getState();
        };
        TrackedItem.prototype.markAsModified = function () {
            this.status = ItemStatus.Modified;
        };
        TrackedItem.prototype.markAsDeleted = function () {
            this.status = ItemStatus.Deleted;
        };
        TrackedItem.prototype.getStatus = function () {
            return this.status;
        };
        TrackedItem.prototype.getItem = function () {
            return this.item;
        };
        TrackedItem.prototype.getKey = function () {
            return this.key;
        };
        TrackedItem.prototype.hasChanged = function () {
            var currentState = this.item.getState();
            var currentStateAsString = JSON.stringify(currentState);
            var asLoadedAsString = JSON.stringify(this.asLoaded);
            return currentStateAsString !== asLoadedAsString;
        };
        TrackedItem.prototype.updateSavedItemStatus = function () {
            if (this.status === ItemStatus.Saved) {
                if (this.hasChanged()) {
                    this.markAsModified();
                }
            }
        };
        return TrackedItem;
    }());
    var IdentityMap = (function () {
        function IdentityMap() {
            this.idToObjectMap = {};
        }
        IdentityMap.prototype.isTracked = function (key) {
            var idAsString = key.toString();
            if (this.idToObjectMap[idAsString]) {
                return true;
            }
            return false;
        };
        IdentityMap.prototype.getById = function (key) {
            var idAsString = key.toString();
            if (this.isTracked(key)) {
                return this.idToObjectMap[idAsString].getItem();
            }
            return null;
        };
        IdentityMap.prototype.add = function (key, item) {
            var idAsString = key.toString();
            var newItem = new TrackedItem(ItemStatus.New, item, key);
            this.idToObjectMap[idAsString] = newItem;
        };
        IdentityMap.prototype.remove = function (key) {
            if (this.isTracked(key)) {
                delete this.idToObjectMap[key.toString()];
            }
        };
        IdentityMap.prototype.getIds = function () {
            var toReturn = [];
            for (var element in this.idToObjectMap) {
                toReturn.push(this.idToObjectMap[element].getKey());
            }
            return toReturn;
        };
        IdentityMap.prototype.markAsDeletedById = function (key) {
            var trackedItem = this.getTrackedItem(key);
            trackedItem.markAsDeleted();
        };
        IdentityMap.prototype.markAsSavedById = function (key) {
            var trackedItem = this.getTrackedItem(key);
            trackedItem.markAsSaved();
        };
        IdentityMap.prototype.markAsModifiedById = function (key) {
            var trackedItem = this.getTrackedItem(key);
            trackedItem.markAsModified();
        };
        IdentityMap.prototype.getItemStatus = function (key) {
            if (this.isTracked(key)) {
                var trackedItem = this.getTrackedItem(key);
                return trackedItem.getStatus();
            }
            return null;
        };
        IdentityMap.prototype.updateSavedItemStatus = function (key) {
            var item = this.getTrackedItem(key);
            item.updateSavedItemStatus();
        };
        IdentityMap.prototype.getTrackedItem = function (key) {
            var toReturn = this.idToObjectMap[key.toString()];
            if (!toReturn) {
                return null;
            }
            return toReturn;
        };
        return IdentityMap;
    }());
    exports.IdentityMap = IdentityMap;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSWRlbnRpdHlNYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvREREVG9vbHMvVW5pdE9mV29yay9JZGVudGl0eU1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztJQVFBLFdBQVksVUFBVTtRQUNsQix5Q0FBRyxDQUFBO1FBQ0gsbURBQVEsQ0FBQTtRQUNSLDZDQUFLLENBQUE7UUFDTCxpREFBTyxDQUFBO0lBQ1gsQ0FBQyxFQUxXLGtCQUFVLEtBQVYsa0JBQVUsUUFLckI7SUFMRCxJQUFZLFVBQVUsR0FBVixrQkFLWCxDQUFBO0lBS0Q7UUFRSSxxQkFDWSxNQUFrQixFQUNsQixJQUFPLEVBQ1AsR0FBUztZQUZULFdBQU0sR0FBTixNQUFNLENBQVk7WUFDbEIsU0FBSSxHQUFKLElBQUksQ0FBRztZQUNQLFFBQUcsR0FBSCxHQUFHLENBQU07WUFFakIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDcEMsQ0FBQztRQUVNLCtCQUFTLEdBQWhCO1lBQ0ksSUFBSSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDO1lBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QyxDQUFDO1FBRU0saUNBQVcsR0FBbEI7WUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUM7WUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pDLENBQUM7UUFFTSxvQ0FBYyxHQUFyQjtZQUNJLElBQUksQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQztRQUN0QyxDQUFDO1FBRU0sbUNBQWEsR0FBcEI7WUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUM7UUFDckMsQ0FBQztRQUVNLCtCQUFTLEdBQWhC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QUFRLENBQUMsQ0FBQyxDQUFDO2dCQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUM7WUFDaEIsQ0FBQztZQUNELE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDcEIsQ0FBQztRQUNMLGtCQUFDO0lBQUQsQ0FBQyxBQW5HRCxJQW1HQztJQW5HWSxtQkFBVyxjQW1HdkIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQge0lBZ2dyZWdhdGVSb290fSBmcm9tIFwiLi4vQWdncmVnYXRlL0lBZ2dyZWdhdGVSb290XCI7XHJcbmltcG9ydCB7SUtleVZhbHVlT2JqZWN0fSBmcm9tIFwiLi4vRW50aXR5L0lLZXlWYWx1ZU9iamVjdFwiO1xyXG5pbXBvcnQge0Jhc2VBZ2dyZWdhdGVSb290fSBmcm9tIFwiLi4vQWdncmVnYXRlL0Jhc2VBZ2dyZWdhdGVSb290XCI7XHJcbmltcG9ydCB7SVBlcnNpc3RhYmxlfSBmcm9tIFwiLi4vUGVyc2lzdGFibGVPYmplY3QvSVBlcnNpc3RhYmxlXCI7XHJcblxyXG4vLyBuYW1lc3BhY2UgREREVG9vbHMuVW5pdE9mV29yayB7XHJcblxyXG5leHBvcnQgZW51bSBJdGVtU3RhdHVzIHtcclxuICAgIE5ldyxcclxuICAgIE1vZGlmaWVkLFxyXG4gICAgU2F2ZWQsXHJcbiAgICBEZWxldGVkXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbnRlcm5hbCBjbGFzcyB0byBzdG9yZSBpdGVtIHN0YXR1cyBpbmZvXHJcbiAqL1xyXG5jbGFzcyBUcmFja2VkSXRlbTxcclxuICAgIFQgZXh0ZW5kcyBCYXNlQWdncmVnYXRlUm9vdDxULCBUS2V5PixcclxuICAgIFRLZXkgZXh0ZW5kcyBJS2V5VmFsdWVPYmplY3Q8VEtleT5cclxuICAgID4ge1xyXG4gICAgLy8gV2lsbCBjb250YWluIGEgc2VyaWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBvYmplY3QgYXMgaXQgd2FzIHdoZW4gaXQgd2FzIGxvYWRlZCBmcm9tIHRoZSByZXBvc2l0b3J5LlxyXG5cclxuICAgIHByaXZhdGUgYXNMb2FkZWQ6IElQZXJzaXN0YWJsZSAvLyBXaWxsIGNvbnRhaW4gdGhlIHN0YXRlIG9mIHRoZSBvYmplY3Qgd2hlbiBmaXJzdCBhZGRlZCBvciB1cGRhdGVkXHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBzdGF0dXM6IEl0ZW1TdGF0dXMsXHJcbiAgICAgICAgcHJpdmF0ZSBpdGVtOiBULFxyXG4gICAgICAgIHByaXZhdGUga2V5OiBUS2V5XHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmFzTG9hZGVkID0gaXRlbS5nZXRTdGF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBtYXJrQXNOZXcoKSB7XHJcbiAgICAgICAgdGhpcy5zdGF0dXMgPSBJdGVtU3RhdHVzLk5ldztcclxuICAgICAgICB0aGlzLmFzTG9hZGVkID0gdGhpcy5pdGVtLmdldFN0YXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG1hcmtBc1NhdmVkKCkge1xyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gSXRlbVN0YXR1cy5TYXZlZDtcclxuICAgICAgICB0aGlzLmFzTG9hZGVkID0gdGhpcy5pdGVtLmdldFN0YXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG1hcmtBc01vZGlmaWVkKCkge1xyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gSXRlbVN0YXR1cy5Nb2RpZmllZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbWFya0FzRGVsZXRlZCgpIHtcclxuICAgICAgICB0aGlzLnN0YXR1cyA9IEl0ZW1TdGF0dXMuRGVsZXRlZDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0U3RhdHVzKCk6IEl0ZW1TdGF0dXMge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnN0YXR1cztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0SXRlbSgpOiBUIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRLZXkoKTogVEtleSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMua2V5O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBoYXNDaGFuZ2VkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSB0aGlzLml0ZW0uZ2V0U3RhdGUoKTtcclxuICAgICAgICB2YXIgY3VycmVudFN0YXRlQXNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShjdXJyZW50U3RhdGUpO1xyXG4gICAgICAgIHZhciBhc0xvYWRlZEFzU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkodGhpcy5hc0xvYWRlZCk7XHJcblxyXG4gICAgICAgIHJldHVybiBjdXJyZW50U3RhdGVBc1N0cmluZyAhPT0gYXNMb2FkZWRBc1N0cmluZztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrcyBpZiBhbiBpdGVtIGluIFwiU2F2ZWRcIiBzdGF0dXMgaGFzIGJlZW4gbW9kaWZpZWQsIGFuZCBjaGFuZ2VzIHRoZSBzdGF0dXMgYWNjb3JkaW5nbHkuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyB1cGRhdGVTYXZlZEl0ZW1TdGF0dXMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSBJdGVtU3RhdHVzLlNhdmVkKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmhhc0NoYW5nZWQoKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tYXJrQXNNb2RpZmllZCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIElkZW50aXR5TWFwXHJcbiAgICA8XHJcbiAgICBUIGV4dGVuZHMgQmFzZUFnZ3JlZ2F0ZVJvb3Q8VCwgVEtleT4sXHJcbiAgICBUS2V5IGV4dGVuZHMgSUtleVZhbHVlT2JqZWN0PFRLZXk+XHJcbiAgICA+XHJcbntcclxuXHJcbiAgICBwcml2YXRlIGlkVG9PYmplY3RNYXA6IHsgW2lkOiBzdHJpbmddOiBUcmFja2VkSXRlbTxULCBUS2V5PiB9XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5pZFRvT2JqZWN0TWFwID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXR1cm5zIHRydWUgaWYga2V5IGlzIGFscmVhZHkgc3RvcmVkIGluIHRoZSBJZGVudGl0eU1hcFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgaXNUcmFja2VkKGtleTogVEtleSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHZhciBpZEFzU3RyaW5nID0ga2V5LnRvU3RyaW5nKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuaWRUb09iamVjdE1hcFtpZEFzU3RyaW5nXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmV0cmlldmVzIGFuIGl0ZW0gZnJvbSB0aGUgSWRlbnRpdHlNYXAuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBnZXRCeUlkKGtleTogVEtleSk6IFQge1xyXG4gICAgICAgIHZhciBpZEFzU3RyaW5nID0ga2V5LnRvU3RyaW5nKCk7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNUcmFja2VkKGtleSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWRUb09iamVjdE1hcFtpZEFzU3RyaW5nXS5nZXRJdGVtKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkcyBvciByZXBsYWNlcyBhbiBpdGVtIHRvIHRoZSBJZGVudGl0eU1hcC5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFkZChrZXk6IFRLZXksIGl0ZW06IFQpOiB2b2lkIHtcclxuICAgICAgICB2YXIgaWRBc1N0cmluZyA9IGtleS50b1N0cmluZygpO1xyXG4gICAgICAgIHZhciBuZXdJdGVtID0gbmV3IFRyYWNrZWRJdGVtKEl0ZW1TdGF0dXMuTmV3LCBpdGVtLCBrZXkpO1xyXG4gICAgICAgIHRoaXMuaWRUb09iamVjdE1hcFtpZEFzU3RyaW5nXSA9IG5ld0l0ZW07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb21wbGV0ZWx5IHJlbW92ZXMgYW4gaXRlbSBmcm9tIHRoZSBJZGVudGl0eU1hcFxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVtb3ZlKGtleTogVEtleSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmlzVHJhY2tlZChrZXkpKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmlkVG9PYmplY3RNYXBba2V5LnRvU3RyaW5nKCldO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0SWRzKCk6IFRLZXlbXSB7XHJcbiAgICAgICAgdmFyIHRvUmV0dXJuOiBUS2V5W10gPSBbXTtcclxuICAgICAgICBmb3IgKHZhciBlbGVtZW50IGluIHRoaXMuaWRUb09iamVjdE1hcCkge1xyXG4gICAgICAgICAgICB0b1JldHVybi5wdXNoKHRoaXMuaWRUb09iamVjdE1hcFtlbGVtZW50XS5nZXRLZXkoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0b1JldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbWFya0FzRGVsZXRlZEJ5SWQoa2V5OiBUS2V5KSB7XHJcbiAgICAgICAgdmFyIHRyYWNrZWRJdGVtID0gdGhpcy5nZXRUcmFja2VkSXRlbShrZXkpO1xyXG4gICAgICAgIHRyYWNrZWRJdGVtLm1hcmtBc0RlbGV0ZWQoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbWFya0FzU2F2ZWRCeUlkKGtleTogVEtleSkge1xyXG4gICAgICAgIHZhciB0cmFja2VkSXRlbSA9IHRoaXMuZ2V0VHJhY2tlZEl0ZW0oa2V5KTtcclxuICAgICAgICB0cmFja2VkSXRlbS5tYXJrQXNTYXZlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBtYXJrQXNNb2RpZmllZEJ5SWQoa2V5OiBUS2V5KSB7XHJcbiAgICAgICAgdmFyIHRyYWNrZWRJdGVtID0gdGhpcy5nZXRUcmFja2VkSXRlbShrZXkpO1xyXG4gICAgICAgIHRyYWNrZWRJdGVtLm1hcmtBc01vZGlmaWVkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEl0ZW1TdGF0dXMoa2V5OiBUS2V5KTogSXRlbVN0YXR1cyB7XHJcbiAgICAgICAgaWYgKHRoaXMuaXNUcmFja2VkKGtleSkpIHtcclxuICAgICAgICAgICAgdmFyIHRyYWNrZWRJdGVtID0gdGhpcy5nZXRUcmFja2VkSXRlbShrZXkpO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJhY2tlZEl0ZW0uZ2V0U3RhdHVzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ29tcHV0ZXMgdGhlIGNvcnJlY3Qgc3RhdHVzIGZvciBhbiBpdGVtIGluIFwiU2F2ZWRcIiBzdGF0dXMsIGFzIGl0IG1heSBoYXZlIGJlZW4gbW9kaWZpZWQgc2luY2Ugbm93IChoZXJlIHdlIGRvbid0IGhhdmUgcHJvcGVydHkgdHJhY2tpbmcpLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgdXBkYXRlU2F2ZWRJdGVtU3RhdHVzKGtleTogVEtleSkge1xyXG4gICAgICAgIHZhciBpdGVtID0gdGhpcy5nZXRUcmFja2VkSXRlbShrZXkpO1xyXG4gICAgICAgIGl0ZW0udXBkYXRlU2F2ZWRJdGVtU3RhdHVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRUcmFja2VkSXRlbShrZXk6IFRLZXkpOiBUcmFja2VkSXRlbTxULCBUS2V5PiB7XHJcbiAgICAgICAgdmFyIHRvUmV0dXJuID0gdGhpcy5pZFRvT2JqZWN0TWFwW2tleS50b1N0cmluZygpXTtcclxuICAgICAgICBpZiAoIXRvUmV0dXJuKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdG9SZXR1cm47XHJcbiAgICB9XHJcbn1cclxuLy8gfSJdfQ==